<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unified Project Portal</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f6f7f9; }
    header { background: #1f2937; color: white; padding: 1rem; }
    main { padding: 1rem; }
    .card { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    button { padding: .5rem 1rem; border-radius: 8px; border: none; cursor: pointer; }
    button.primary { background: #2563eb; color: white; }
    input { padding: .5rem; width: 100%; margin-bottom: .5rem; }
  </style>
</head>
<body>
  <header>
    <h1>Unified Project Portal</h1>
    <p>Canvasâ€‘connected group projects</p>
  </header>

  <main>
    <!-- AUTH UI -->
    <div class="card" id="auth">
      <h2>Sign in</h2>
      <button id="googleBtn" class="primary">Sign in with Google</button>
      <button id="emailBtn">Sign in with Email</button>
    </div>

    <!-- APP UI (hidden until auth) -->
    <div id="app" hidden>
      <div class="card">
        <button id="logoutBtn">Logout</button>
        <h2>Your Projects</h2>
        <ul id="projectList"></ul>
        <button class="primary" id="newProjectBtn">+ New Project</button>
      </div>

      <div class="card" id="projectView" hidden>
        <h2 id="projectTitle"></h2>
        <section>
          <h3>Messages</h3>
          <ul id="messages"></ul>
          <input id="messageInput" placeholder="Type a message" />
          <button id="sendMessageBtn">Send</button>
        </section>
      </div>
    </div>
  </main>

  <script type="module">
/* ======================================================
   ProjectPlus â€“ FULL CEILING BUILD ðŸš€
   Auth â€¢ Members â€¢ Roles â€¢ Realtime â€¢ Files â€¢ Canvas
   ====================================================== */

// ---------------- Firebase imports ----------------
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  doc,
  updateDoc,
  onSnapshot,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getStorage,
  ref,
  uploadBytes,
  getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-storage.js";

// ---------------- Firebase config ----------------
const firebaseConfig = {
  apiKey: "AIzaSyABiF_qcnKQ4WQYNj0gg94_gKwphv3SX1w",
  authDomain: "project-plus-2c7bc.firebaseapp.com",
  projectId: "project-plus-2c7bc",
  storageBucket: "project-plus-2c7bc.appspot.com",
  messagingSenderId: "985256399261",
  appId: "1:985256399261:web:fc0e5053ac70ac6cb51f74"
};

// ---------------- Init ----------------
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

// ---------------- State ----------------
const state = {
  user: null,
  projects: [],
  currentProject: null,
  unsubProjects: null,
  unsubProject: null
};

// ================= AUTH =================
async function googleSignIn() {
  await signInWithPopup(auth, new GoogleAuthProvider());
}

async function emailSignIn() {
  const email = prompt('Email');
  const pass = prompt('Password');
  if (!email || !pass) return;
  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch {
    await createUserWithEmailAndPassword(auth, email, pass);
  }
}

function logout() {
  signOut(auth);
}

// ================= PROJECTS =================
function projectsRef() {
  return collection(db, 'projects');
}

function subscribeProjects() {
  if (state.unsubProjects) state.unsubProjects();

  const q = query(projectsRef(), where('members', 'array-contains', state.user.uid));

  state.unsubProjects = onSnapshot(q, snap => {
    state.projects = [];
    snap.forEach(d => state.projects.push({ id: d.id, ...d.data() }));
    renderProjects();
  });
}

async function createProject() {
  const name = prompt('Project name');
  if (!name) return;

  await addDoc(projectsRef(), {
    name,
    owner: state.user.uid,
    members: [state.user.uid],
    roles: { [state.user.uid]: 'owner' },
    messages: [],
    files: [],
    canvas: null,
    created: Date.now()
  });
}

function openProject(project) {
  if (state.unsubProject) state.unsubProject();

  state.unsubProject = onSnapshot(doc(db, 'projects', project.id), d => {
    state.currentProject = { id: d.id, ...d.data() };
    document.getElementById('projectView').hidden = false;
    document.getElementById('projectTitle').textContent = state.currentProject.name;
    renderMessages();
    renderMembers();
    renderFiles();
    renderCanvas();
  });
}

// ================= MESSAGES =================
async function sendMessage() {
  const input = document.getElementById('messageInput');
  if (!input.value) return;

  const msg = {
    text: input.value,
    sender: state.user.email,
    time: Date.now()
  };

  await updateDoc(doc(db, 'projects', state.currentProject.id), {
    messages: [...state.currentProject.messages, msg]
  });

  input.value = '';
}

function renderMessages() {
  const list = document.getElementById('messages');
  list.innerHTML = '';
  state.currentProject.messages.forEach(m => {
    const li = document.createElement('li');
    li.textContent = `${m.sender}: ${m.text}`;
    list.appendChild(li);
  });
}

// ================= MEMBERS =================
async function inviteMember() {
  const email = prompt('Invite email');
  if (!email) return;

  await updateDoc(doc(db, 'projects', state.currentProject.id), {
    invited: [...(state.currentProject.invited || []), email]
  });
}

function renderMembers() {
  const list = document.getElementById('members');
  list.innerHTML = '';
  state.currentProject.members.forEach(uid => {
    const li = document.createElement('li');
    li.textContent = uid === state.user.uid ? 'You' : uid;
    list.appendChild(li);
  });
}

// ================= FILES =================
async function uploadFile(e) {
  const file = e.target.files[0];
  if (!file) return;

  const fileRef = ref(storage, `projects/${state.currentProject.id}/${file.name}`);
  await uploadBytes(fileRef, file);
  const url = await getDownloadURL(fileRef);

  await updateDoc(doc(db, 'projects', state.currentProject.id), {
    files: [...state.currentProject.files, { name: file.name, url }]
  });
}

function renderFiles() {
  const list = document.getElementById('files');
  list.innerHTML = '';
  state.currentProject.files.forEach(f => {
    const li = document.createElement('li');
    const a = document.createElement('a');
    a.href = f.url;
    a.textContent = f.name;
    a.target = '_blank';
    li.appendChild(a);
    list.appendChild(li);
  });
}

// ================= CANVAS LMS =================
async function linkCanvas() {
  const token = prompt('Paste Canvas API token');
  if (!token) return;

  await updateDoc(doc(db, 'projects', state.currentProject.id), {
    canvas: { token }
  });
}

async function renderCanvas() {
  const box = document.getElementById('canvasBox');
  box.innerHTML = state.currentProject.canvas
    ? 'Canvas linked (token stored)'
    : 'Canvas not linked';
}

// ================= UI =================
function renderProjects() {
  const list = document.getElementById('projectList');
  list.innerHTML = '';
  state.projects.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p.name;
    li.onclick = () => openProject(p);
    list.appendChild(li);
  });
}

// ================= AUTH STATE =================
onAuthStateChanged(auth, user => {
  state.user = user;
  document.getElementById('auth').hidden = !!user;
  document.getElementById('app').hidden = !user;
  if (user) subscribeProjects();
});

// ================= STARTUP =================
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('googleBtn').onclick = googleSignIn;
  document.getElementById('emailBtn').onclick = emailSignIn;
  document.getElementById('logoutBtn').onclick = logout;
  document.getElementById('newProjectBtn').onclick = createProject;
  document.getElementById('sendMessageBtn').onclick = sendMessage;
  document.getElementById('inviteBtn').onclick = inviteMember;
  document.getElementById('fileInput').onchange = uploadFile;
  document.getElementById('canvasBtn').onclick = linkCanvas;
});
</script>
</body>
</html>
