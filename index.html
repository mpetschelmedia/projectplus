<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Unified Project Portal</title>
  <style>
    body { font-family: system-ui, sans-serif; margin: 0; background: #f6f7f9; }
    header { background: #1f2937; color: white; padding: 1rem; }
    main { padding: 1rem; }
    .card { background: white; border-radius: 12px; padding: 1rem; margin-bottom: 1rem; box-shadow: 0 2px 6px rgba(0,0,0,.08); }
    button { padding: .5rem 1rem; border-radius: 8px; border: none; cursor: pointer; }
    button.primary { background: #2563eb; color: white; }
    input { padding: .5rem; width: 100%; margin-bottom: .5rem; }
  </style>
</head>
<body>
  <header>
    <h1>Unified Project Portal</h1>
    <p>Canvas‑connected group projects</p>
  </header>

  <main>
    <div class="card">
      <h2>Your Projects</h2>
      <ul id="projectList"></ul>
      <button class="primary" id="newProjectBtn">+ New Project</button>
    </div>

    <div class="card" id="projectView" hidden>
      <h2 id="projectTitle"></h2>
      <section>
        <h3>Messages</h3>
        <ul id="messages"></ul>
        <input id="messageInput" placeholder="Type a message" />
        <button id="sendMessageBtn">Send</button>
      </section>

      <section>
        <h3>Resources</h3>
        <ul id="resources"></ul>
      </section>
    </div>
  </main>

  <script type="module">
/* =====================================
   ProjectPlus – Auth + Realtime + Members
   ===================================== */

// ---- Firebase imports ----
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getAuth,
  GoogleAuthProvider,
  signInWithPopup,
  signInWithEmailAndPassword,
  createUserWithEmailAndPassword,
  onAuthStateChanged,
  signOut
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  getDocs,
  doc,
  updateDoc,
  onSnapshot,
  query,
  where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

// ---- Firebase config ----
const firebaseConfig = {
  apiKey: "AIzaSyABiF_qcnKQ4WQYNj0gg94_gKwphv3SX1w",
  authDomain: "project-plus-2c7bc.firebaseapp.com",
  projectId: "project-plus-2c7bc",
  storageBucket: "project-plus-2c7bc.appspot.com",
  messagingSenderId: "985256399261",
  appId: "1:985256399261:web:fc0e5053ac70ac6cb51f74"
};

// ---- Init ----
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ---- State ----
const state = {
  user: null,
  projects: [],
  currentProject: null,
  unsubProjects: null,
  unsubMessages: null
};

// ---- Auth UI helpers ----
async function googleSignIn() {
  const provider = new GoogleAuthProvider();
  await signInWithPopup(auth, provider);
}

async function emailSignIn() {
  const email = prompt('Email');
  const pass = prompt('Password');
  if (!email || !pass) return;

  try {
    await signInWithEmailAndPassword(auth, email, pass);
  } catch {
    await createUserWithEmailAndPassword(auth, email, pass);
  }
}

function logout() {
  signOut(auth);
}

// ---- Firestore refs ----
function projectsRef() {
  return collection(db, 'projects');
}

// ---- Realtime projects ----
function subscribeProjects() {
  if (state.unsubProjects) state.unsubProjects();

  const q = query(
    projectsRef(),
    where('members', 'array-contains', state.user.uid)
  );

  state.unsubProjects = onSnapshot(q, snap => {
    state.projects = [];
    snap.forEach(d => state.projects.push({ id: d.id, ...d.data() }));
    renderProjects();
  });
}

// ---- Messages realtime ----
function subscribeMessages(project) {
  if (state.unsubMessages) state.unsubMessages();

  state.unsubMessages = onSnapshot(
    doc(db, 'projects', project.id),
    d => {
      state.currentProject = { id: d.id, ...d.data() };
      renderMessages();
    }
  );
}

// ---- UI ----
function renderProjects() {
  const list = document.getElementById('projectList');
  list.innerHTML = '';

  state.projects.forEach(p => {
    const li = document.createElement('li');
    li.textContent = p.name;
    li.onclick = () => openProject(p);
    list.appendChild(li);
  });
}

function renderMessages() {
  const list = document.getElementById('messages');
  list.innerHTML = '';
  if (!state.currentProject) return;

  state.currentProject.messages.forEach(m => {
    const li = document.createElement('li');
    li.textContent = `${m.sender}: ${m.text}`;
    list.appendChild(li);
  });
}

// ---- Core actions ----
async function createProject() {
  const name = prompt('Project name');
  if (!name) return;

  await addDoc(projectsRef(), {
    name,
    members: [state.user.uid],
    messages: [],
    created: Date.now()
  });
}

function openProject(project) {
  state.currentProject = project;
  document.getElementById('projectView').hidden = false;
  document.getElementById('projectTitle').textContent = project.name;
  subscribeMessages(project);
}

async function sendMessage() {
  const input = document.getElementById('messageInput');
  if (!input.value) return;

  const msgs = [...state.currentProject.messages, {
    text: input.value,
    sender: state.user.email,
    time: Date.now()
  }];

  await updateDoc(doc(db, 'projects', state.currentProject.id), {
    messages: msgs
  });

  input.value = '';
}

// ---- Auth state ----
onAuthStateChanged(auth, user => {
  state.user = user;

  document.getElementById('auth').hidden = !!user;
  document.getElementById('app').hidden = !user;

  if (user) subscribeProjects();
});

// ---- Startup ----
document.addEventListener('DOMContentLoaded', () => {
  document.getElementById('googleBtn').onclick = googleSignIn;
  document.getElementById('emailBtn').onclick = emailSignIn;
  document.getElementById('logoutBtn').onclick = logout;
  document.getElementById('newProjectBtn').onclick = createProject;
  document.getElementById('sendMessageBtn').onclick = sendMessage;
});

/* ---- Canvas LMS integration placeholder ----
   Next step:
   - OAuth token
   - /api/v1/courses
   - /api/v1/assignments
*/
</script>
</body>
</html>
